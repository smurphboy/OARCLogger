{% extends 'base.html' %}
{% block scripts %}
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
{% endblock %}
{% block hero %}is-primary{% endblock %}
{% block content %}
    <div class="bd-hero-heading">
        <h1 class="title is-size-1">
            {% block title %} <p>Add a New QSO for {{ station_callsign }}</p> {% endblock %}
        </h1>
        <div class="subtitle is-4 algolia-lvl1">
            <p>Enter QSO details below and press Add:</p>     
        </div>
    </div>
</section>
<section class="section">
    <form method="POST" id="qsoform">
        {{ form.csrf_token }}
        <div class="card">
            <header class="card-header">
                <p class="card-header-title">Date & Time</p>
                <button class="card-header-icon" id="dateandtime" aria-label="more options">
                    <span class="icon">
                        <i class="fas fa-angle-down" aria-hidden="true"></i>
                    </span>
                </button>
            </header>
            <div class="card-content" id="dateandtime-content">
                <nav class="level">
                    <div class="level-left">
                        <div class="level-item">
                            <div class="field">
                                {{ form.qso_date.label(class_="label") }}
                                <p class="control is-expanded">
                                {{ form.qso_date(class_="input") }}
                                </p>
                            </div>
                            {% if form.qso_date.errors %}
                                <ul class="errors">
                                    {% for error in form.qso_date.errors %}
                                        <li>{{ error }}</li>
                                    {% endfor %}
                                </ul>
                            {% endif %}
                        </div>
                        <div class="level-item">
                            <div class="field">
                                {{ form.time_on.label(class_="label") }}
                                <p class="control is-expanded">
                                {{ form.time_on(class_="input") }}
                                </p>
                            </div>
                            {% if form.time_on.errors %}
                                <ul class="errors">
                                    {% for error in form.time_on.errors %}
                                        <li>{{ error }}</li>
                                    {% endfor %}
                                </ul>
                            {% endif %}
                        </div>
                    </div>
                    <div class="level-right">
                        <div class="level-item">
                            <div class="field">
                                {{ form.qso_date_off.label(class_="label") }}
                                <p class="control is-expanded">
                                {{ form.qso_date_off(class_="input") }}
                                </p>
                            </div>
                            {% if form.qso_date_off.errors %}
                                <ul class="errors">
                                    {% for error in form.qso_date_off.errors %}
                                        <li>{{ error }}</li>
                                    {% endfor %}
                                </ul>
                            {% endif %}
                        </div>
                        <div class="level-item">
                            <div class="field">
                                {{ form.time_off.label(class_="label") }}
                                <p class="control is-expanded">
                                {{ form.time_off(class_="input") }}
                                </p>
                            </div>
                            {% if form.time_off.errors %}
                                <ul class="errors">
                                    {% for error in form.time_off.errors %}
                                        <li>{{ error }}</li>
                                    {% endfor %}
                                </ul>
                            {% endif %}
                        </div>
                    </div>
                </nav>
            </div>
            <footer class="card-footer" id="datetime-footer">
                <a class="card-footer-item" id="qsoon">Set QSO On</a>
                <a class="card-footer-item" id="qsooff">Set QSO Off</a>
            </footer>
        </div>
        <div class="card">
            <header class="card-header">
                <p class="card-header-title">Callsigns</p>
                <button class="card-header-icon" id="callsigns" aria-label="more options">
                    <span class="icon">
                        <i class="fas fa-angle-down" aria-hidden="true"></i>
                    </span>
                </button>
            </header>
            <div class="card-content" id="callsigns-content">
                <nav class="level">
                    <div class="level-left">
                        <div class="level-item">
                            <div class="field">
                                {{ form.call.label(class_='label') }}
                                <div class="control">
                                    {{ form.call(class_="input", placeholder_="Called station") }}
                                </div>
                            </div>
                            {% if form.call.errors %}
                                <ul class="errors">
                                    {% for error in form.call.errors %}
                                        <li>{{ error }}</li>
                                    {% endfor %}
                                </ul>
                            {% endif %}
                        </div>
                        <div class="level-item">
                            <div class="field">
                                {{ form.dxcc.label(class_='label') }}
                                <div class="control">
                                    {{ form.dxcc(class_="input", placeholder_="DXCC of the called station") }}
                                </div>
                            </div>
                            {% if form.dxcc.errors %}
                                <ul class="errors">
                                    {% for error in form.dxcc.errors %}
                                        <li>{{ error }}</li>
                                    {% endfor %}
                                </ul>
                            {% endif %}
                        </div>
                        <div class="level-item">
                            <div class="field">
                                {{ form.cqz.label(class_='label') }}
                                <div class="control">
                                    {{ form.cqz(class_="input", placeholder_="CQ Zone of the called station") }}
                                </div>
                            </div>
                            {% if form.cqz.errors %}
                                <ul class="errors">
                                    {% for error in form.cqz.errors %}
                                        <li>{{ error }}</li>
                                    {% endfor %}
                                </ul>
                            {% endif %}
                        </div>
                        <div class="level-item">
                            <div class="field">
                                {{ form.ituz.label(class_='label') }}
                                <div class="control">
                                    {{ form.ituz(class_="input", placeholder_="ITU Zone of the called station") }}
                                </div>
                            </div>
                            {% if form.ituz.errors %}
                                <ul class="errors">
                                    {% for error in form.ituz.errors %}
                                        <li>{{ error }}</li>
                                    {% endfor %}
                                </ul>
                            {% endif %}
                        </div>    
                    </div>
                </nav>
            </div>
            <footer class="card-footer" id="callsigns-footer">
                <button class="button card-footer-item" id="lookupbutton">Lookup Callsign</button>
            </footer>
        </div>
        <div class="card">
            <div class="field">
                {{ form.mode.label(class_="label") }}
                <div class="select">
                {{ form.mode() }}
                </div>
            </div>

            {% if form.mode.errors %}
                <ul class="errors">
                    {% for error in form.mode.errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
        </div>
        <div class="card">
            <div class="field">
                {{ form.band.label(class_="label") }}
                <div class="select">
                {{ form.band() }}
                </div>
            </div>

            {% if form.band.errors %}
                <ul class="errors">
                    {% for error in form.band.errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}

            <div class="field">
                {{ form.gridsquare.label(class_='label') }}
                <div class="control">
                    {{ form.gridsquare(class_="input") }}
                </div>
            </div>

            {% if form.gridsquare.errors %}
                <ul class="errors">
                    {% for error in form.gridsquare.errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}

            <div class="field">
                {{ form.my_gridsquare.label(class_='label') }}
                <div class="control">
                    {{ form.my_gridsquare(class_="input") }}
                </div>
            </div>

            {% if form.my_gridsquare.errors %}
                <ul class="errors">
                    {% for error in form.my_gridsquare.errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
        </div>
        <button class="button is-link" name="add_qso" type="submit" form="qsoform">Add QSO</button>
    </form>
</section>

<script>
    $SCRIPT_ROOT = {{ request.script_root|tojson }};
</script>
<script>

$(document).ready(function() {

    $("#dateandtime").click(function() {
    $("#dateandtime-content").toggleClass('is-hidden');
    });

    $("#callsigns").click(function() {
    $("#callsigns-content").toggleClass('is-hidden');
    });

    $("#callsigns").click(function() {
    $("#callsigns-footer").toggleClass('is-hidden');
    });

    var today = new Date();
    var dd = today.getUTCDate();
    var mm = today.getUTCMonth()+1; //January is 0!
    var yyyy = today.getUTCFullYear();
    var hh = today.getUTCHours();
    var minutes = today.getUTCMinutes();

    if(dd<10){dd='0'+dd} 
    if(mm<10){mm='0'+mm}
    if(hh<10){hh='0'+hh}
    if(minutes<10){minutes='0'+minutes} 
    today = yyyy+'-'+mm+'-'+dd;
    todaytime = hh+':'+minutes;

    $("#qsoon").click(function() {
    $("#qso_date").val(today),
    $("#time_on").val(todaytime);
    });

    $("#qsooff").click(function() {
    $("#qso_date_off").val(today),
    $("#time_off").val(todaytime);
    });

    $(function() {
        $('#lookupbutton').click(function() {
        $.getJSON($SCRIPT_ROOT + '/qsos/_dxcc', {
            callsign: $('input[name="call"]').val()
        }, function(data) {
            $("#dxcc").val(data.dxcc),
            $("#ituz").val(data.ituz),
            $("#cqz").val(data.cqz);
        });
        return false;
        });
    });
});
</script>
{% endblock %}
